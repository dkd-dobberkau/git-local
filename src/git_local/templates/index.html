{% extends "base.html" %}

{% block content %}
<header class="header">
  <div class="header-left"></div>
  <div class="header-title">{{ title }}</div>
  <div class="header-actions">
    <button
      class="header-icon"
      hx-get="/partials/repos"
      hx-target="#repo-list"
      hx-swap="innerHTML"
      title="Aktualisieren"
    >
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <path d="M21 12a9 9 0 1 1-9-9c2.52 0 4.93 1 6.74 2.74L21 8"/>
        <path d="M21 3v5h-5"/>
      </svg>
    </button>
  </div>
</header>

<main class="main">
  <div class="filter-bar">
    <input
      type="text"
      class="filter-input"
      placeholder="Filter..."
      oninput="filterRepos(this.value)"
    >
    <div class="sort-buttons">
      <button class="sort-btn active" onclick="sortRepos('date')" title="Nach Datum">Datum</button>
      <button class="sort-btn" onclick="sortRepos('name')" title="Alphabetisch">A-Z</button>
      <button class="sort-btn" onclick="sortRepos('remote')" title="Nach Remote">Remote</button>
    </div>
    <span class="repo-count"><span id="visible-count">{{ repo_count }}</span> / {{ repo_count }} Repositories</span>
  </div>

  <div id="repo-list">
    {% include "components/repo_list.html" %}
  </div>
</main>

<script>
function filterRepos(query) {
  const items = document.querySelectorAll('.repo-item');
  const q = query.toLowerCase();
  let visible = 0;

  items.forEach(item => {
    const name = item.querySelector('.repo-item-name').textContent.toLowerCase();
    const badges = item.querySelectorAll('.badge');
    let badgeMatch = false;
    badges.forEach(b => {
      if (b.textContent.toLowerCase().includes(q)) badgeMatch = true;
    });

    if (name.includes(q) || badgeMatch) {
      item.style.display = '';
      visible++;
    } else {
      item.style.display = 'none';
    }
  });

  document.getElementById('visible-count').textContent = visible;
}

function sortRepos(by) {
  const list = document.querySelector('.repo-list');
  const items = Array.from(list.querySelectorAll('.repo-item'));

  // Update active button
  document.querySelectorAll('.sort-btn').forEach(btn => btn.classList.remove('active'));
  event.target.classList.add('active');

  items.sort((a, b) => {
    if (by === 'name') {
      return a.dataset.name.localeCompare(b.dataset.name);
    } else if (by === 'date') {
      return parseFloat(b.dataset.date) - parseFloat(a.dataset.date);
    } else if (by === 'remote') {
      const remoteA = a.dataset.remote || 'zzz';
      const remoteB = b.dataset.remote || 'zzz';
      return remoteA.localeCompare(remoteB);
    }
  });

  items.forEach(item => list.appendChild(item));
}
</script>
{% endblock %}
